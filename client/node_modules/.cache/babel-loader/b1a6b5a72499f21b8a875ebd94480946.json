{"ast":null,"code":"import _toConsumableArray from \"C:/Users/mumta/crewmates/client/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";\nimport _classCallCheck from \"C:/Users/mumta/crewmates/client/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";\nimport _createClass from \"C:/Users/mumta/crewmates/client/node_modules/@babel/runtime/helpers/esm/createClass.js\";\n\n/*\r\n  This file draws heavily from https://github.com/phoenixframework/phoenix/blob/d344ec0a732ab4ee204215b31de69cf4be72e3bf/assets/js/phoenix/presence.js\r\n  License: https://github.com/phoenixframework/phoenix/blob/d344ec0a732ab4ee204215b31de69cf4be72e3bf/LICENSE.md\r\n*/\nexport var REALTIME_PRESENCE_LISTEN_EVENTS;\n\n(function (REALTIME_PRESENCE_LISTEN_EVENTS) {\n  REALTIME_PRESENCE_LISTEN_EVENTS[\"SYNC\"] = \"sync\";\n  REALTIME_PRESENCE_LISTEN_EVENTS[\"JOIN\"] = \"join\";\n  REALTIME_PRESENCE_LISTEN_EVENTS[\"LEAVE\"] = \"leave\";\n})(REALTIME_PRESENCE_LISTEN_EVENTS || (REALTIME_PRESENCE_LISTEN_EVENTS = {}));\n\nvar RealtimePresence = /*#__PURE__*/function () {\n  /**\r\n   * Initializes the Presence.\r\n   *\r\n   * @param channel - The RealtimeChannel\r\n   * @param opts - The options,\r\n   *        for example `{events: {state: 'state', diff: 'diff'}}`\r\n   */\n  function RealtimePresence(channel, opts) {\n    var _this = this;\n\n    _classCallCheck(this, RealtimePresence);\n\n    this.channel = channel;\n    this.state = {};\n    this.pendingDiffs = [];\n    this.joinRef = null;\n    this.caller = {\n      onJoin: function onJoin() {},\n      onLeave: function onLeave() {},\n      onSync: function onSync() {}\n    };\n    var events = (opts === null || opts === void 0 ? void 0 : opts.events) || {\n      state: 'presence_state',\n      diff: 'presence_diff'\n    };\n\n    this.channel._on(events.state, {}, function (newState) {\n      var _this$caller = _this.caller,\n          onJoin = _this$caller.onJoin,\n          onLeave = _this$caller.onLeave,\n          onSync = _this$caller.onSync;\n      _this.joinRef = _this.channel._joinRef();\n      _this.state = RealtimePresence.syncState(_this.state, newState, onJoin, onLeave);\n\n      _this.pendingDiffs.forEach(function (diff) {\n        _this.state = RealtimePresence.syncDiff(_this.state, diff, onJoin, onLeave);\n      });\n\n      _this.pendingDiffs = [];\n      onSync();\n    });\n\n    this.channel._on(events.diff, {}, function (diff) {\n      var _this$caller2 = _this.caller,\n          onJoin = _this$caller2.onJoin,\n          onLeave = _this$caller2.onLeave,\n          onSync = _this$caller2.onSync;\n\n      if (_this.inPendingSyncState()) {\n        _this.pendingDiffs.push(diff);\n      } else {\n        _this.state = RealtimePresence.syncDiff(_this.state, diff, onJoin, onLeave);\n        onSync();\n      }\n    });\n\n    this.onJoin(function (key, currentPresences, newPresences) {\n      _this.channel._trigger('presence', {\n        event: 'join',\n        key: key,\n        currentPresences: currentPresences,\n        newPresences: newPresences\n      });\n    });\n    this.onLeave(function (key, currentPresences, leftPresences) {\n      _this.channel._trigger('presence', {\n        event: 'leave',\n        key: key,\n        currentPresences: currentPresences,\n        leftPresences: leftPresences\n      });\n    });\n    this.onSync(function () {\n      _this.channel._trigger('presence', {\n        event: 'sync'\n      });\n    });\n  }\n  /**\r\n   * Used to sync the list of presences on the server with the\r\n   * client's state.\r\n   *\r\n   * An optional `onJoin` and `onLeave` callback can be provided to\r\n   * react to changes in the client's local presences across\r\n   * disconnects and reconnects with the server.\r\n   *\r\n   * @internal\r\n   */\n\n\n  _createClass(RealtimePresence, [{\n    key: \"onJoin\",\n    value:\n    /** @internal */\n    function onJoin(callback) {\n      this.caller.onJoin = callback;\n    }\n    /** @internal */\n\n  }, {\n    key: \"onLeave\",\n    value: function onLeave(callback) {\n      this.caller.onLeave = callback;\n    }\n    /** @internal */\n\n  }, {\n    key: \"onSync\",\n    value: function onSync(callback) {\n      this.caller.onSync = callback;\n    }\n    /** @internal */\n\n  }, {\n    key: \"inPendingSyncState\",\n    value: function inPendingSyncState() {\n      return !this.joinRef || this.joinRef !== this.channel._joinRef();\n    }\n  }], [{\n    key: \"syncState\",\n    value: function syncState(currentState, newState, onJoin, onLeave) {\n      var state = this.cloneDeep(currentState);\n      var transformedState = this.transformState(newState);\n      var joins = {};\n      var leaves = {};\n      this.map(state, function (key, presences) {\n        if (!transformedState[key]) {\n          leaves[key] = presences;\n        }\n      });\n      this.map(transformedState, function (key, newPresences) {\n        var currentPresences = state[key];\n\n        if (currentPresences) {\n          var newPresenceRefs = newPresences.map(function (m) {\n            return m.presence_ref;\n          });\n          var curPresenceRefs = currentPresences.map(function (m) {\n            return m.presence_ref;\n          });\n          var joinedPresences = newPresences.filter(function (m) {\n            return curPresenceRefs.indexOf(m.presence_ref) < 0;\n          });\n          var leftPresences = currentPresences.filter(function (m) {\n            return newPresenceRefs.indexOf(m.presence_ref) < 0;\n          });\n\n          if (joinedPresences.length > 0) {\n            joins[key] = joinedPresences;\n          }\n\n          if (leftPresences.length > 0) {\n            leaves[key] = leftPresences;\n          }\n        } else {\n          joins[key] = newPresences;\n        }\n      });\n      return this.syncDiff(state, {\n        joins: joins,\n        leaves: leaves\n      }, onJoin, onLeave);\n    }\n    /**\r\n     * Used to sync a diff of presence join and leave events from the\r\n     * server, as they happen.\r\n     *\r\n     * Like `syncState`, `syncDiff` accepts optional `onJoin` and\r\n     * `onLeave` callbacks to react to a user joining or leaving from a\r\n     * device.\r\n     *\r\n     * @internal\r\n     */\n\n  }, {\n    key: \"syncDiff\",\n    value: function syncDiff(state, diff, onJoin, onLeave) {\n      var _this2 = this;\n\n      var _joins$leaves = {\n        joins: this.transformState(diff.joins),\n        leaves: this.transformState(diff.leaves)\n      },\n          joins = _joins$leaves.joins,\n          leaves = _joins$leaves.leaves;\n\n      if (!onJoin) {\n        onJoin = function onJoin() {};\n      }\n\n      if (!onLeave) {\n        onLeave = function onLeave() {};\n      }\n\n      this.map(joins, function (key, newPresences) {\n        var _a;\n\n        var currentPresences = (_a = state[key]) !== null && _a !== void 0 ? _a : [];\n        state[key] = _this2.cloneDeep(newPresences);\n\n        if (currentPresences.length > 0) {\n          var _state$key;\n\n          var joinedPresenceRefs = state[key].map(function (m) {\n            return m.presence_ref;\n          });\n          var curPresences = currentPresences.filter(function (m) {\n            return joinedPresenceRefs.indexOf(m.presence_ref) < 0;\n          });\n\n          (_state$key = state[key]).unshift.apply(_state$key, _toConsumableArray(curPresences));\n        }\n\n        onJoin(key, currentPresences, newPresences);\n      });\n      this.map(leaves, function (key, leftPresences) {\n        var currentPresences = state[key];\n        if (!currentPresences) return;\n        var presenceRefsToRemove = leftPresences.map(function (m) {\n          return m.presence_ref;\n        });\n        currentPresences = currentPresences.filter(function (m) {\n          return presenceRefsToRemove.indexOf(m.presence_ref) < 0;\n        });\n        state[key] = currentPresences;\n        onLeave(key, currentPresences, leftPresences);\n        if (currentPresences.length === 0) delete state[key];\n      });\n      return state;\n    }\n    /** @internal */\n\n  }, {\n    key: \"map\",\n    value: function map(obj, func) {\n      return Object.getOwnPropertyNames(obj).map(function (key) {\n        return func(key, obj[key]);\n      });\n    }\n    /**\r\n     * Remove 'metas' key\r\n     * Change 'phx_ref' to 'presence_ref'\r\n     * Remove 'phx_ref' and 'phx_ref_prev'\r\n     *\r\n     * @example\r\n     * // returns {\r\n     *  abc123: [\r\n     *    { presence_ref: '2', user_id: 1 },\r\n     *    { presence_ref: '3', user_id: 2 }\r\n     *  ]\r\n     * }\r\n     * RealtimePresence.transformState({\r\n     *  abc123: {\r\n     *    metas: [\r\n     *      { phx_ref: '2', phx_ref_prev: '1' user_id: 1 },\r\n     *      { phx_ref: '3', user_id: 2 }\r\n     *    ]\r\n     *  }\r\n     * })\r\n     *\r\n     * @internal\r\n     */\n\n  }, {\n    key: \"transformState\",\n    value: function transformState(state) {\n      state = this.cloneDeep(state);\n      return Object.getOwnPropertyNames(state).reduce(function (newState, key) {\n        var presences = state[key];\n\n        if ('metas' in presences) {\n          newState[key] = presences.metas.map(function (presence) {\n            presence['presence_ref'] = presence['phx_ref'];\n            delete presence['phx_ref'];\n            delete presence['phx_ref_prev'];\n            return presence;\n          });\n        } else {\n          newState[key] = presences;\n        }\n\n        return newState;\n      }, {});\n    }\n    /** @internal */\n\n  }, {\n    key: \"cloneDeep\",\n    value: function cloneDeep(obj) {\n      return JSON.parse(JSON.stringify(obj));\n    }\n  }]);\n\n  return RealtimePresence;\n}();\n\nexport { RealtimePresence as default };","map":{"version":3,"mappings":";;;;AAAA;;;;AAkCA,WAAYA,+BAAZ;;AAAA,WAAYA,+BAAZ,EAA2C;EACzCA;EACAA;EACAA;AACD,CAJD,EAAYA,+BAA+B,KAA/BA,+BAA+B,MAA3C;;IA4BqBC,gB;EAcnB;;;;;;;EAOA,0BAAmBC,OAAnB,EAA6CC,IAA7C,EAAgE;IAAA;;IAAA;;IAA7C;IApBnB,aAA+B,EAA/B;IACA,oBAAkC,EAAlC;IACA,eAAyB,IAAzB;IACA,cAII;MACFC,MAAM,EAAE,kBAAK,CAAG,CADd;MAEFC,OAAO,EAAE,mBAAK,CAAG,CAFf;MAGFC,MAAM,EAAE,kBAAK,CAAG;IAHd,CAJJ;IAkBE,IAAMC,MAAM,GAAG,KAAI,SAAJ,QAAI,WAAJ,GAAI,MAAJ,OAAI,CAAEA,MAAN,KAAgB;MAC7BC,KAAK,EAAE,gBADsB;MAE7BC,IAAI,EAAE;IAFuB,CAA/B;;IAKA,KAAKP,OAAL,CAAaQ,GAAb,CAAiBH,MAAM,CAACC,KAAxB,EAA+B,EAA/B,EAAmC,UAACG,QAAD,EAA+B;MAChE,mBAAoC,KAAI,CAACC,MAAzC;MAAA,IAAQR,MAAR,gBAAQA,MAAR;MAAA,IAAgBC,OAAhB,gBAAgBA,OAAhB;MAAA,IAAyBC,MAAzB,gBAAyBA,MAAzB;MAEA,KAAI,CAACO,OAAL,GAAe,KAAI,CAACX,OAAL,CAAaY,QAAb,EAAf;MAEA,KAAI,CAACN,KAAL,GAAaP,gBAAgB,CAACc,SAAjB,CACX,KAAI,CAACP,KADM,EAEXG,QAFW,EAGXP,MAHW,EAIXC,OAJW,CAAb;;MAOA,KAAI,CAACW,YAAL,CAAkBC,OAAlB,CAA0B,UAACR,IAAD,EAAS;QACjC,KAAI,CAACD,KAAL,GAAaP,gBAAgB,CAACiB,QAAjB,CACX,KAAI,CAACV,KADM,EAEXC,IAFW,EAGXL,MAHW,EAIXC,OAJW,CAAb;MAMD,CAPD;;MASA,KAAI,CAACW,YAAL,GAAoB,EAApB;MAEAV,MAAM;IACP,CAxBD;;IA0BA,KAAKJ,OAAL,CAAaQ,GAAb,CAAiBH,MAAM,CAACE,IAAxB,EAA8B,EAA9B,EAAkC,UAACA,IAAD,EAA0B;MAC1D,oBAAoC,KAAI,CAACG,MAAzC;MAAA,IAAQR,MAAR,iBAAQA,MAAR;MAAA,IAAgBC,OAAhB,iBAAgBA,OAAhB;MAAA,IAAyBC,MAAzB,iBAAyBA,MAAzB;;MAEA,IAAI,KAAI,CAACa,kBAAL,EAAJ,EAA+B;QAC7B,KAAI,CAACH,YAAL,CAAkBI,IAAlB,CAAuBX,IAAvB;MACD,CAFD,MAEO;QACL,KAAI,CAACD,KAAL,GAAaP,gBAAgB,CAACiB,QAAjB,CACX,KAAI,CAACV,KADM,EAEXC,IAFW,EAGXL,MAHW,EAIXC,OAJW,CAAb;QAOAC,MAAM;MACP;IACF,CAfD;;IAiBA,KAAKF,MAAL,CAAY,UAACiB,GAAD,EAAMC,gBAAN,EAAwBC,YAAxB,EAAwC;MAClD,KAAI,CAACrB,OAAL,CAAasB,QAAb,CAAsB,UAAtB,EAAkC;QAChCC,KAAK,EAAE,MADyB;QAEhCJ,GAAG,EAAHA,GAFgC;QAGhCC,gBAAgB,EAAhBA,gBAHgC;QAIhCC,YAAY,EAAZA;MAJgC,CAAlC;IAMD,CAPD;IASA,KAAKlB,OAAL,CAAa,UAACgB,GAAD,EAAMC,gBAAN,EAAwBI,aAAxB,EAAyC;MACpD,KAAI,CAACxB,OAAL,CAAasB,QAAb,CAAsB,UAAtB,EAAkC;QAChCC,KAAK,EAAE,OADyB;QAEhCJ,GAAG,EAAHA,GAFgC;QAGhCC,gBAAgB,EAAhBA,gBAHgC;QAIhCI,aAAa,EAAbA;MAJgC,CAAlC;IAMD,CAPD;IASA,KAAKpB,MAAL,CAAY,YAAK;MACf,KAAI,CAACJ,OAAL,CAAasB,QAAb,CAAsB,UAAtB,EAAkC;QAAEC,KAAK,EAAE;MAAT,CAAlC;IACD,CAFD;EAGD;EAED;;;;;;;;;;;;;;;IA6LA;IACQ,gBAAOE,QAAP,EAAuC;MAC7C,KAAKf,MAAL,CAAYR,MAAZ,GAAqBuB,QAArB;IACD;IAED;;;;WACQ,iBAAQA,QAAR,EAAyC;MAC/C,KAAKf,MAAL,CAAYP,OAAZ,GAAsBsB,QAAtB;IACD;IAED;;;;WACQ,gBAAOA,QAAP,EAA2B;MACjC,KAAKf,MAAL,CAAYN,MAAZ,GAAqBqB,QAArB;IACD;IAED;;;;WACQ,8BAAkB;MACxB,OAAO,CAAC,KAAKd,OAAN,IAAiB,KAAKA,OAAL,KAAiB,KAAKX,OAAL,CAAaY,QAAb,EAAzC;IACD;;;WArMO,mBACNc,YADM,EAENjB,QAFM,EAGNP,MAHM,EAINC,OAJM,EAI0B;MAEhC,IAAMG,KAAK,GAAG,KAAKqB,SAAL,CAAeD,YAAf,CAAd;MACA,IAAME,gBAAgB,GAAG,KAAKC,cAAL,CAAoBpB,QAApB,CAAzB;MACA,IAAMqB,KAAK,GAA0B,EAArC;MACA,IAAMC,MAAM,GAA0B,EAAtC;MAEA,KAAKC,GAAL,CAAS1B,KAAT,EAAgB,UAACa,GAAD,EAAcc,SAAd,EAAuC;QACrD,IAAI,CAACL,gBAAgB,CAACT,GAAD,CAArB,EAA4B;UAC1BY,MAAM,CAACZ,GAAD,CAAN,GAAcc,SAAd;QACD;MACF,CAJD;MAMA,KAAKD,GAAL,CAASJ,gBAAT,EAA2B,UAACT,GAAD,EAAME,YAAN,EAAkC;QAC3D,IAAMD,gBAAgB,GAAed,KAAK,CAACa,GAAD,CAA1C;;QAEA,IAAIC,gBAAJ,EAAsB;UACpB,IAAMc,eAAe,GAAGb,YAAY,CAACW,GAAb,CACtB,UAACG,CAAD;YAAA,OAAiBA,CAAC,CAACC,YAAnB;UAAA,CADsB,CAAxB;UAGA,IAAMC,eAAe,GAAGjB,gBAAgB,CAACY,GAAjB,CACtB,UAACG,CAAD;YAAA,OAAiBA,CAAC,CAACC,YAAnB;UAAA,CADsB,CAAxB;UAGA,IAAME,eAAe,GAAejB,YAAY,CAACkB,MAAb,CAClC,UAACJ,CAAD;YAAA,OAAiBE,eAAe,CAACG,OAAhB,CAAwBL,CAAC,CAACC,YAA1B,IAA0C,CAA3D;UAAA,CADkC,CAApC;UAGA,IAAMZ,aAAa,GAAeJ,gBAAgB,CAACmB,MAAjB,CAChC,UAACJ,CAAD;YAAA,OAAiBD,eAAe,CAACM,OAAhB,CAAwBL,CAAC,CAACC,YAA1B,IAA0C,CAA3D;UAAA,CADgC,CAAlC;;UAIA,IAAIE,eAAe,CAACG,MAAhB,GAAyB,CAA7B,EAAgC;YAC9BX,KAAK,CAACX,GAAD,CAAL,GAAamB,eAAb;UACD;;UAED,IAAId,aAAa,CAACiB,MAAd,GAAuB,CAA3B,EAA8B;YAC5BV,MAAM,CAACZ,GAAD,CAAN,GAAcK,aAAd;UACD;QACF,CArBD,MAqBO;UACLM,KAAK,CAACX,GAAD,CAAL,GAAaE,YAAb;QACD;MACF,CA3BD;MA6BA,OAAO,KAAKL,QAAL,CAAcV,KAAd,EAAqB;QAAEwB,KAAK,EAALA,KAAF;QAASC,MAAM,EAANA;MAAT,CAArB,EAAwC7B,MAAxC,EAAgDC,OAAhD,CAAP;IACD;IAED;;;;;;;;;;;;;WAUQ,kBACNG,KADM,EAENC,IAFM,EAGNL,MAHM,EAINC,OAJM,EAI0B;MAAA;;MAEhC,oBAA0B;QACxB2B,KAAK,EAAE,KAAKD,cAAL,CAAoBtB,IAAI,CAACuB,KAAzB,CADiB;QAExBC,MAAM,EAAE,KAAKF,cAAL,CAAoBtB,IAAI,CAACwB,MAAzB;MAFgB,CAA1B;MAAA,IAAQD,KAAR,iBAAQA,KAAR;MAAA,IAAeC,MAAf,iBAAeA,MAAf;;MAKA,IAAI,CAAC7B,MAAL,EAAa;QACXA,MAAM,GAAG,kBAAK,CAAG,CAAjB;MACD;;MAED,IAAI,CAACC,OAAL,EAAc;QACZA,OAAO,GAAG,mBAAK,CAAG,CAAlB;MACD;;MAED,KAAK6B,GAAL,CAASF,KAAT,EAAgB,UAACX,GAAD,EAAME,YAAN,EAAkC;;;QAChD,IAAMD,gBAAgB,GAAe,WAAK,CAACD,GAAD,CAAL,MAAU,IAAV,IAAUuB,aAAV,GAAUA,EAAV,GAAc,EAAnD;QACApC,KAAK,CAACa,GAAD,CAAL,GAAa,MAAI,CAACQ,SAAL,CAAeN,YAAf,CAAb;;QAEA,IAAID,gBAAgB,CAACqB,MAAjB,GAA0B,CAA9B,EAAiC;UAAA;;UAC/B,IAAME,kBAAkB,GAAGrC,KAAK,CAACa,GAAD,CAAL,CAAWa,GAAX,CACzB,UAACG,CAAD;YAAA,OAAiBA,CAAC,CAACC,YAAnB;UAAA,CADyB,CAA3B;UAGA,IAAMQ,YAAY,GAAexB,gBAAgB,CAACmB,MAAjB,CAC/B,UAACJ,CAAD;YAAA,OAAiBQ,kBAAkB,CAACH,OAAnB,CAA2BL,CAAC,CAACC,YAA7B,IAA6C,CAA9D;UAAA,CAD+B,CAAjC;;UAIA,mBAAK,CAACjB,GAAD,CAAL,EAAW0B,OAAX,sCAAsBD,YAAtB;QACD;;QAED1C,MAAM,CAACiB,GAAD,EAAMC,gBAAN,EAAwBC,YAAxB,CAAN;MACD,CAhBD;MAkBA,KAAKW,GAAL,CAASD,MAAT,EAAiB,UAACZ,GAAD,EAAMK,aAAN,EAAmC;QAClD,IAAIJ,gBAAgB,GAAed,KAAK,CAACa,GAAD,CAAxC;QAEA,IAAI,CAACC,gBAAL,EAAuB;QAEvB,IAAM0B,oBAAoB,GAAGtB,aAAa,CAACQ,GAAd,CAC3B,UAACG,CAAD;UAAA,OAAiBA,CAAC,CAACC,YAAnB;QAAA,CAD2B,CAA7B;QAGAhB,gBAAgB,GAAGA,gBAAgB,CAACmB,MAAjB,CACjB,UAACJ,CAAD;UAAA,OAAiBW,oBAAoB,CAACN,OAArB,CAA6BL,CAAC,CAACC,YAA/B,IAA+C,CAAhE;QAAA,CADiB,CAAnB;QAIA9B,KAAK,CAACa,GAAD,CAAL,GAAaC,gBAAb;QAEAjB,OAAO,CAACgB,GAAD,EAAMC,gBAAN,EAAwBI,aAAxB,CAAP;QAEA,IAAIJ,gBAAgB,CAACqB,MAAjB,KAA4B,CAAhC,EAAmC,OAAOnC,KAAK,CAACa,GAAD,CAAZ;MACpC,CAjBD;MAmBA,OAAOb,KAAP;IACD;IAED;;;;WACQ,aACNyC,GADM,EAENC,IAFM,EAEkB;MAExB,OAAOC,MAAM,CAACC,mBAAP,CAA2BH,GAA3B,EAAgCf,GAAhC,CAAoC,UAACb,GAAD;QAAA,OAAS6B,IAAI,CAAC7B,GAAD,EAAM4B,GAAG,CAAC5B,GAAD,CAAT,CAAb;MAAA,CAApC,CAAP;IACD;IAED;;;;;;;;;;;;;;;;;;;;;;;;;;WAuBQ,wBACNb,KADM,EACyC;MAE/CA,KAAK,GAAG,KAAKqB,SAAL,CAAerB,KAAf,CAAR;MAEA,OAAO2C,MAAM,CAACC,mBAAP,CAA2B5C,KAA3B,EAAkC6C,MAAlC,CAAyC,UAAC1C,QAAD,EAAWU,GAAX,EAAkB;QAChE,IAAMc,SAAS,GAAG3B,KAAK,CAACa,GAAD,CAAvB;;QAEA,IAAI,WAAWc,SAAf,EAA0B;UACxBxB,QAAQ,CAACU,GAAD,CAAR,GAAgBc,SAAS,CAACmB,KAAV,CAAgBpB,GAAhB,CAAoB,UAACqB,QAAD,EAAa;YAC/CA,QAAQ,CAAC,cAAD,CAAR,GAA2BA,QAAQ,CAAC,SAAD,CAAnC;YAEA,OAAOA,QAAQ,CAAC,SAAD,CAAf;YACA,OAAOA,QAAQ,CAAC,cAAD,CAAf;YAEA,OAAOA,QAAP;UACD,CAPe,CAAhB;QAQD,CATD,MASO;UACL5C,QAAQ,CAACU,GAAD,CAAR,GAAgBc,SAAhB;QACD;;QAED,OAAOxB,QAAP;MACD,CAjBM,EAiBJ,EAjBI,CAAP;IAkBD;IAED;;;;WACQ,mBAAiBsC,GAAjB,EAA4C;MAClD,OAAOO,IAAI,CAACC,KAAL,CAAWD,IAAI,CAACE,SAAL,CAAeT,GAAf,CAAX,CAAP;IACD;;;;;;SAxRkBhD,gB","names":["REALTIME_PRESENCE_LISTEN_EVENTS","RealtimePresence","channel","opts","onJoin","onLeave","onSync","events","state","diff","_on","newState","caller","joinRef","_joinRef","syncState","pendingDiffs","forEach","syncDiff","inPendingSyncState","push","key","currentPresences","newPresences","_trigger","event","leftPresences","callback","currentState","cloneDeep","transformedState","transformState","joins","leaves","map","presences","newPresenceRefs","m","presence_ref","curPresenceRefs","joinedPresences","filter","indexOf","length","_a","joinedPresenceRefs","curPresences","unshift","presenceRefsToRemove","obj","func","Object","getOwnPropertyNames","reduce","metas","presence","JSON","parse","stringify"],"sources":["C:\\Users\\mumta\\crewmates\\client\\node_modules\\@supabase\\realtime-js\\src\\RealtimePresence.ts"],"sourcesContent":["/*\r\n  This file draws heavily from https://github.com/phoenixframework/phoenix/blob/d344ec0a732ab4ee204215b31de69cf4be72e3bf/assets/js/phoenix/presence.js\r\n  License: https://github.com/phoenixframework/phoenix/blob/d344ec0a732ab4ee204215b31de69cf4be72e3bf/LICENSE.md\r\n*/\r\n\r\nimport type {\r\n  PresenceOpts,\r\n  PresenceOnJoinCallback,\r\n  PresenceOnLeaveCallback,\r\n} from 'phoenix'\r\nimport type RealtimeChannel from './RealtimeChannel'\r\n\r\ntype Presence<T extends { [key: string]: any } = {}> = {\r\n  presence_ref: string\r\n} & T\r\n\r\nexport type RealtimePresenceState<T extends { [key: string]: any } = {}> = {\r\n  [key: string]: Presence<T>[]\r\n}\r\n\r\nexport type RealtimePresenceJoinPayload<T extends { [key: string]: any }> = {\r\n  event: `${REALTIME_PRESENCE_LISTEN_EVENTS.JOIN}`\r\n  key: string\r\n  currentPresences: Presence<T>[]\r\n  newPresences: Presence<T>[]\r\n}\r\n\r\nexport type RealtimePresenceLeavePayload<T extends { [key: string]: any }> = {\r\n  event: `${REALTIME_PRESENCE_LISTEN_EVENTS.LEAVE}`\r\n  key: string\r\n  currentPresences: Presence<T>[]\r\n  leftPresences: Presence<T>[]\r\n}\r\n\r\nexport enum REALTIME_PRESENCE_LISTEN_EVENTS {\r\n  SYNC = 'sync',\r\n  JOIN = 'join',\r\n  LEAVE = 'leave',\r\n}\r\n\r\ntype PresenceDiff = {\r\n  joins: RealtimePresenceState\r\n  leaves: RealtimePresenceState\r\n}\r\n\r\ntype RawPresenceState = {\r\n  [key: string]: {\r\n    metas: {\r\n      phx_ref?: string\r\n      phx_ref_prev?: string\r\n      [key: string]: any\r\n    }[]\r\n  }\r\n}\r\n\r\ntype RawPresenceDiff = {\r\n  joins: RawPresenceState\r\n  leaves: RawPresenceState\r\n}\r\n\r\ntype PresenceChooser<T> = (key: string, presences: Presence[]) => T\r\n\r\nexport default class RealtimePresence {\r\n  state: RealtimePresenceState = {}\r\n  pendingDiffs: RawPresenceDiff[] = []\r\n  joinRef: string | null = null\r\n  caller: {\r\n    onJoin: PresenceOnJoinCallback\r\n    onLeave: PresenceOnLeaveCallback\r\n    onSync: () => void\r\n  } = {\r\n    onJoin: () => {},\r\n    onLeave: () => {},\r\n    onSync: () => {},\r\n  }\r\n\r\n  /**\r\n   * Initializes the Presence.\r\n   *\r\n   * @param channel - The RealtimeChannel\r\n   * @param opts - The options,\r\n   *        for example `{events: {state: 'state', diff: 'diff'}}`\r\n   */\r\n  constructor(public channel: RealtimeChannel, opts?: PresenceOpts) {\r\n    const events = opts?.events || {\r\n      state: 'presence_state',\r\n      diff: 'presence_diff',\r\n    }\r\n\r\n    this.channel._on(events.state, {}, (newState: RawPresenceState) => {\r\n      const { onJoin, onLeave, onSync } = this.caller\r\n\r\n      this.joinRef = this.channel._joinRef()\r\n\r\n      this.state = RealtimePresence.syncState(\r\n        this.state,\r\n        newState,\r\n        onJoin,\r\n        onLeave\r\n      )\r\n\r\n      this.pendingDiffs.forEach((diff) => {\r\n        this.state = RealtimePresence.syncDiff(\r\n          this.state,\r\n          diff,\r\n          onJoin,\r\n          onLeave\r\n        )\r\n      })\r\n\r\n      this.pendingDiffs = []\r\n\r\n      onSync()\r\n    })\r\n\r\n    this.channel._on(events.diff, {}, (diff: RawPresenceDiff) => {\r\n      const { onJoin, onLeave, onSync } = this.caller\r\n\r\n      if (this.inPendingSyncState()) {\r\n        this.pendingDiffs.push(diff)\r\n      } else {\r\n        this.state = RealtimePresence.syncDiff(\r\n          this.state,\r\n          diff,\r\n          onJoin,\r\n          onLeave\r\n        )\r\n\r\n        onSync()\r\n      }\r\n    })\r\n\r\n    this.onJoin((key, currentPresences, newPresences) => {\r\n      this.channel._trigger('presence', {\r\n        event: 'join',\r\n        key,\r\n        currentPresences,\r\n        newPresences,\r\n      })\r\n    })\r\n\r\n    this.onLeave((key, currentPresences, leftPresences) => {\r\n      this.channel._trigger('presence', {\r\n        event: 'leave',\r\n        key,\r\n        currentPresences,\r\n        leftPresences,\r\n      })\r\n    })\r\n\r\n    this.onSync(() => {\r\n      this.channel._trigger('presence', { event: 'sync' })\r\n    })\r\n  }\r\n\r\n  /**\r\n   * Used to sync the list of presences on the server with the\r\n   * client's state.\r\n   *\r\n   * An optional `onJoin` and `onLeave` callback can be provided to\r\n   * react to changes in the client's local presences across\r\n   * disconnects and reconnects with the server.\r\n   *\r\n   * @internal\r\n   */\r\n  private static syncState(\r\n    currentState: RealtimePresenceState,\r\n    newState: RawPresenceState | RealtimePresenceState,\r\n    onJoin: PresenceOnJoinCallback,\r\n    onLeave: PresenceOnLeaveCallback\r\n  ): RealtimePresenceState {\r\n    const state = this.cloneDeep(currentState)\r\n    const transformedState = this.transformState(newState)\r\n    const joins: RealtimePresenceState = {}\r\n    const leaves: RealtimePresenceState = {}\r\n\r\n    this.map(state, (key: string, presences: Presence[]) => {\r\n      if (!transformedState[key]) {\r\n        leaves[key] = presences\r\n      }\r\n    })\r\n\r\n    this.map(transformedState, (key, newPresences: Presence[]) => {\r\n      const currentPresences: Presence[] = state[key]\r\n\r\n      if (currentPresences) {\r\n        const newPresenceRefs = newPresences.map(\r\n          (m: Presence) => m.presence_ref\r\n        )\r\n        const curPresenceRefs = currentPresences.map(\r\n          (m: Presence) => m.presence_ref\r\n        )\r\n        const joinedPresences: Presence[] = newPresences.filter(\r\n          (m: Presence) => curPresenceRefs.indexOf(m.presence_ref) < 0\r\n        )\r\n        const leftPresences: Presence[] = currentPresences.filter(\r\n          (m: Presence) => newPresenceRefs.indexOf(m.presence_ref) < 0\r\n        )\r\n\r\n        if (joinedPresences.length > 0) {\r\n          joins[key] = joinedPresences\r\n        }\r\n\r\n        if (leftPresences.length > 0) {\r\n          leaves[key] = leftPresences\r\n        }\r\n      } else {\r\n        joins[key] = newPresences\r\n      }\r\n    })\r\n\r\n    return this.syncDiff(state, { joins, leaves }, onJoin, onLeave)\r\n  }\r\n\r\n  /**\r\n   * Used to sync a diff of presence join and leave events from the\r\n   * server, as they happen.\r\n   *\r\n   * Like `syncState`, `syncDiff` accepts optional `onJoin` and\r\n   * `onLeave` callbacks to react to a user joining or leaving from a\r\n   * device.\r\n   *\r\n   * @internal\r\n   */\r\n  private static syncDiff(\r\n    state: RealtimePresenceState,\r\n    diff: RawPresenceDiff | PresenceDiff,\r\n    onJoin: PresenceOnJoinCallback,\r\n    onLeave: PresenceOnLeaveCallback\r\n  ): RealtimePresenceState {\r\n    const { joins, leaves } = {\r\n      joins: this.transformState(diff.joins),\r\n      leaves: this.transformState(diff.leaves),\r\n    }\r\n\r\n    if (!onJoin) {\r\n      onJoin = () => {}\r\n    }\r\n\r\n    if (!onLeave) {\r\n      onLeave = () => {}\r\n    }\r\n\r\n    this.map(joins, (key, newPresences: Presence[]) => {\r\n      const currentPresences: Presence[] = state[key] ?? []\r\n      state[key] = this.cloneDeep(newPresences)\r\n\r\n      if (currentPresences.length > 0) {\r\n        const joinedPresenceRefs = state[key].map(\r\n          (m: Presence) => m.presence_ref\r\n        )\r\n        const curPresences: Presence[] = currentPresences.filter(\r\n          (m: Presence) => joinedPresenceRefs.indexOf(m.presence_ref) < 0\r\n        )\r\n\r\n        state[key].unshift(...curPresences)\r\n      }\r\n\r\n      onJoin(key, currentPresences, newPresences)\r\n    })\r\n\r\n    this.map(leaves, (key, leftPresences: Presence[]) => {\r\n      let currentPresences: Presence[] = state[key]\r\n\r\n      if (!currentPresences) return\r\n\r\n      const presenceRefsToRemove = leftPresences.map(\r\n        (m: Presence) => m.presence_ref\r\n      )\r\n      currentPresences = currentPresences.filter(\r\n        (m: Presence) => presenceRefsToRemove.indexOf(m.presence_ref) < 0\r\n      )\r\n\r\n      state[key] = currentPresences\r\n\r\n      onLeave(key, currentPresences, leftPresences)\r\n\r\n      if (currentPresences.length === 0) delete state[key]\r\n    })\r\n\r\n    return state\r\n  }\r\n\r\n  /** @internal */\r\n  private static map<T = any>(\r\n    obj: RealtimePresenceState,\r\n    func: PresenceChooser<T>\r\n  ): T[] {\r\n    return Object.getOwnPropertyNames(obj).map((key) => func(key, obj[key]))\r\n  }\r\n\r\n  /**\r\n   * Remove 'metas' key\r\n   * Change 'phx_ref' to 'presence_ref'\r\n   * Remove 'phx_ref' and 'phx_ref_prev'\r\n   *\r\n   * @example\r\n   * // returns {\r\n   *  abc123: [\r\n   *    { presence_ref: '2', user_id: 1 },\r\n   *    { presence_ref: '3', user_id: 2 }\r\n   *  ]\r\n   * }\r\n   * RealtimePresence.transformState({\r\n   *  abc123: {\r\n   *    metas: [\r\n   *      { phx_ref: '2', phx_ref_prev: '1' user_id: 1 },\r\n   *      { phx_ref: '3', user_id: 2 }\r\n   *    ]\r\n   *  }\r\n   * })\r\n   *\r\n   * @internal\r\n   */\r\n  private static transformState(\r\n    state: RawPresenceState | RealtimePresenceState\r\n  ): RealtimePresenceState {\r\n    state = this.cloneDeep(state)\r\n\r\n    return Object.getOwnPropertyNames(state).reduce((newState, key) => {\r\n      const presences = state[key]\r\n\r\n      if ('metas' in presences) {\r\n        newState[key] = presences.metas.map((presence) => {\r\n          presence['presence_ref'] = presence['phx_ref']\r\n\r\n          delete presence['phx_ref']\r\n          delete presence['phx_ref_prev']\r\n\r\n          return presence\r\n        }) as Presence[]\r\n      } else {\r\n        newState[key] = presences\r\n      }\r\n\r\n      return newState\r\n    }, {} as RealtimePresenceState)\r\n  }\r\n\r\n  /** @internal */\r\n  private static cloneDeep(obj: { [key: string]: any }) {\r\n    return JSON.parse(JSON.stringify(obj))\r\n  }\r\n\r\n  /** @internal */\r\n  private onJoin(callback: PresenceOnJoinCallback): void {\r\n    this.caller.onJoin = callback\r\n  }\r\n\r\n  /** @internal */\r\n  private onLeave(callback: PresenceOnLeaveCallback): void {\r\n    this.caller.onLeave = callback\r\n  }\r\n\r\n  /** @internal */\r\n  private onSync(callback: () => void): void {\r\n    this.caller.onSync = callback\r\n  }\r\n\r\n  /** @internal */\r\n  private inPendingSyncState(): boolean {\r\n    return !this.joinRef || this.joinRef !== this.channel._joinRef()\r\n  }\r\n}\r\n"]},"metadata":{},"sourceType":"module"}